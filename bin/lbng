#!/usr/bin/env python

"""
live-build-ng - Live-Build NG
(C) Iain R. Learmonth 2015 <irl@debian.org>
See COPYING for terms of usage, modification and redistribution.

bin/lbng - Live-Build NG (Application)
"""

import sys
import os
import cliapp
import logging
import subprocess
import lbng.isolinux
from vmdebootstrap.base import runcmd
from lbng.vm import vmdebootstrap
from lbng.xorriso import Xorriso

__version__ = '0.1'

class LiveBuildNG(cliapp.Application):

    def add_settings(self):
        self.settings.string(
                ['o', 'image_output'], 'Location for built image',
                metavar='/PATH/TO/FILE.ISO',
                default='live.iso', group='Base Settings')
        self.settings.string(
                ['d', 'distribution'], 'Debian release to use (default: %default)',
                metavar='NAME',
                default='stable', group='Base Settings')
        self.settings.string(
                ['m', 'mirror'], 'Mirror to use for image creation',
                metavar='MIRROR',
                group='Base Settings')
        self.settings.boolean(
                ['isolinux'], 'Add isolinux bootloader to the image (default: %default)',
                default=True, group="Bootloaders")
        self.settings.boolean(
                ['grub'], 'Add GRUB bootloader to the image (for EFI support) (default: %default)',
                default=True, group="Bootloaders")

    def process_args(self, args):
        if not self.settings['isolinux'] and not self.settings['grub']:
            cliapp.AppException("You must enable at least one bootloader!")
        if os.geteuid() != 0:
            sys.exit("You need to have root privileges to run this script.")
        self.start_ops()

    def start_ops(self):
        #Create work directory
        if not os.path.exists("cdroot"):
            os.mkdir("cdroot")
        else:
            cliapp.AppException("A cdroot directory already exists. Please remove before building a fresh image.")

        #Run vmdebootstrap
        vm = VMDebootstrap(self.settings['distribution'],
                mirror=self.settings['mirror'])
        vm.run()

        #Install isolinux if selected
        if self.settings['isolinux']:
            lbng.isolinux.install_isolinux('cdroot')    

        #Create ISO image
        xorriso = Xorriso(self.settings['image_output'],
                isolinux=self.settings['isolinux'],
                grub=self.settings['grub'])
        xorriso.build_image()

        #Done
        sys.exit("Completed successfully.")

if __name__ == "__main__":
    LiveBuildNG(version=__version__).run()
